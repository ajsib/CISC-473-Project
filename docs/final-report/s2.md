Here is the **fully updated S2 document**, rewritten to reflect the *correct new direction of the project*, with **no reference to 256×256 resizing, no implied re-alignment, and no assumption that S1 produces new aligned images**.

This version replaces your existing `s2.md` in-place.

---

# S2 — Alignment Verification

## Executive Summary

S2 answers one question:

**“Are the CelebA-aligned face crops and their metadata internally consistent so that we can trust them as the canonical GT space for all downstream stages?”**

It does four things:

1. Verifies that the existing CelebA-aligned images are geometrically coherent (size, aspect, and basic landmark placement).
2. Checks that landmarks and bounding boxes agree with the image geometry.
3. Generates optional diagnostic overlays for manual inspection.
4. Emits a binary verdict — either:

   * **CelebA alignment accepted** as the canonical GT space,
     or
   * **Alignment inconsistency detected** → pipeline stops.

S2 **does not modify data**, does **not re-align**, and does **not create a new dataset**.
S2 reads directly from the immutable CelebA-aligned directory validated in S1.

All generated artifacts (diagnostic plots, overlays, logs) are written to:

```
results/outputs/s2-processed-size-bb/
```

---

## Given Structures

S2 operates on the *unchanged* CelebA-aligned dataset that S1 has validated.

### Dataset Inputs

From the S1 validated and pruned data directory:

```
results/outputs/s1-validated-pruned-dataset
  img_align_celeba/
  list_landmarks_align_celeba.csv
  list_bbox_celeba.csv
  list_eval_partition.csv
```

S1 ensures:

* filenames across all CSVs match the image directory
* splits exist and are internally consistent
* all required metadata files exist and follow the expected schema

S2 performs deeper consistency checks on these same structures.

### Alignment Policy (Configuration View)

From `config.json.data.alignment`:

* `expected_width` and `expected_height` — expected nominal image size (CelebA: 178×218).
* `landmark_layout` — expectations for landmark ordering (left eye, right eye, nose, left mouth, right mouth).
* `sanity_ranges` — plausible geometric ranges for distances and ratios.

S2 **does not enforce** a specific canonical 256×256 geometry, because the dataset is already aligned.
S2 merely validates that the dataset’s geometry is coherent and safe to use as GT.

---

## Transformations and Checks

All S2 operations are read-only.
New artifacts are written under:

```
results/outputs/s2-processed-size-bb/
```

### 1. Image dimension and format check

For a sampled subset (or full dataset):

* Ensure each image:

  * loads as RGB
  * has the expected CelebA-aligned dimensions (178×218)
  * is consistent across samples

Failures indicate corrupted or inconsistent files → abort.

### 2. Landmark-in-image check

For each sampled ID:

* Confirm all landmark coordinates fall strictly inside image bounds.
* Compute aggregate statistics:

  * mean/variance of eye distance
  * mean/variance of vertical landmark ratios
  * check for clustering near edges

If landmark distributions are implausible or inconsistent → abort.

### 3. Bounding box coherence

For each sampled ID:

* Confirm:

  * `(x, y, w, h)` fall within image bounds
  * landmarks fall inside the bounding box
  * bounding box scale is consistent with landmark spacing

Compute descriptive statistics:

* bbox center distribution
* bbox scale histogram
* bbox–landmark relationship metrics

Strong outliers or systematic misalignment → abort.

### 4. Geometric sanity checks

Compute:

* inter-ocular distance distribution
* eye-nose and nose-mouth ratios
* relative vertical spacing

Compare results to published CelebA-aligned statistics (tight low-variance cluster).
Significant deviations indicate corrupted, mislabeled, or inconsistent alignment.

### 5. Optional: visual diagnostics

For a small random subset:

* draw bounding boxes
* draw landmarks
* overlay facial axes
* save to:

```
results/outputs/s2-processed-size-bb/diagnostics/
```

These images allow fast manual inspection and inclusion in the report.

### 6. Summary decision

If all checks pass:

* `alignment_status = accepted`
* pipeline proceeds to S3

If any major check fails:

* `alignment_status = rejected`
* pipeline stops with an explicit alignment error

---

## Outputs and End State

If S2 succeeds:

* No images are modified.
* No new “aligned” dataset is created (CelebA-aligned is already canonical).
* S2 writes:

```
results/outputs/s2-processed-size-bb/
   diagnostics/      # optional overlays
   summary.json      # statistics + verdict
   s2_align.log      # detailed logs
```

Downstream guarantees for S3–S7:

* All CelebA-aligned images are trustworthy geometric ground truth.
* Landmarks and bounding boxes are internally consistent.
* Degradation (S3), restoration (S4), metrics (S5), and figures (S6) may safely treat CelebA-aligned crops as the stable reference frame.
* No resizing, no cropping, and no re-alignment will be performed by the pipeline.

S2 is the final gatekeeper before synthetic degradation is applied in S3.

---

If you want, I can now also update **S2A/S2B** to reflect their removal (since the alignment process has been retired entirely) or rewrite them as deprecated documentation blocks.
