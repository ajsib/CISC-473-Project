# S3 — Synthetic Degradation

## Executive Summary

S3 takes clean, aligned face images and generates controlled low-quality (LQ) versions that serve as inputs to GFPGAN and CodeFormer.

It does four things:

1. Reads the CelebA-aligned ground-truth faces (178×218) and their metadata.
2. Applies a set of well-defined degradation presets (blur, JPEG compression, noise) from `config.json`.
3. Writes the degraded images into a structured results tree, separated by preset.
4. Emits a manifest linking each degraded image back to its ground truth, degradation preset, and split.

S3 is deterministic given the config and seed.
It defines the exact input distribution that both restoration models must handle.

---

## Given Structures

### Inputs

Assuming S1 has completed:

* Aligned images (GT) for degradation come from the S1-pruned output directory:

  * `results/outputs/s1-validated-pruned-dataset/img_align_celeba/`
  * 178×218 CelebA-aligned crops, filenames compatible with original IDs.

* Evaluation partition (pruned, validated):

  * `results/outputs/s1-validated-pruned-dataset/list_eval_partition.csv`
  * Maps image filenames → partition label `{0,1,2}`.

* Degradation configuration (`config.json.data.degradations`):

  * `presets` — list of named degradations:

    * `name`
    * `type` (`gaussian_blur`, `jpeg`, `gaussian_noise`)
    * parameters (`sigma`, `quality`, etc.)

  * `seed` — global RNG seed.

  * `output_size` — expected LQ output size (set to `null` to keep source geometry).

### Output Locations (Contract)

S3 writes only under:

```
results/outputs/s3-degrade/
```

and logs under:

```
results/logs/
```

Specifically:

* Degraded images:
  `results/outputs/s3-degrade/<preset>/imgs/`

* Logs:
  `results/logs/s3_degrade.log`

* Manifest:
  `results/logs/s3_degrade_manifest.csv`

---

## Transformations and Checks

The process is deterministic once `presets` and `seed` are fixed.

### 1. Initialization

* Seed all RNGs.
* Enumerate all aligned GT images in:
  `results/outputs/s1-validated-pruned-dataset/img_align_celeba/`
* Join filenames with the S1 partition CSV:
  `results/outputs/s1-validated-pruned-dataset/list_eval_partition.csv`.

### 2. Per-preset degradation loop

For each preset:

* Create output directory:
  `results/outputs/s3-degrade/<preset.name>/imgs/`

* For each image:

  * Load GT image from:
    `results/outputs/s1-validated-pruned-dataset/img_align_celeba/<id>.jpg`

  * Apply degradation:

    * **Gaussian blur** — kernel defined by `sigma`
    * **JPEG compression** — reencode using preset `quality`
    * **Gaussian noise** — pixel-wise noise with preset `sigma`

  * If `output_size` is set, enforce that size; otherwise keep the source geometry.

  * Save degraded image to:
    `results/outputs/s3-degrade/<preset.name>/imgs/<id>.jpg`

### 3. Manifest construction

For every `(image_id, preset)` pair, write a row with:

* `id`
* `path_gt` —
  `results/outputs/s1-validated-pruned-dataset/img_align_celeba/<id>.jpg`
* `path_deg` —
  `results/outputs/s3-degrade/<preset>/imgs/<id>.jpg`
* `degradation`
* `split` — partition label from S1

The manifest is written to:

```
results/logs/s3_degrade_manifest.csv
```

### 4. Sanity checks

After generation, S3 verifies that:

* all outputs exist on disk
* all outputs decode correctly as RGB
* all shapes match `output_size` when set; otherwise native source geometry
* the number of LQ images matches the number of GT images

Any mismatch triggers a logged error and termination.

---

## Outputs and End State

When S3 completes:

* All degraded images exist under:
  `results/outputs/s3-degrade/<preset>/imgs/`

* `results/logs/s3_degrade_manifest.csv` contains authoritative mappings for all `(GT, LQ)` pairs.

* `results/logs/s3_degrade.log` contains a full operational record.

Downstream usage:

* **S4A GFPGAN** and **S4B CodeFormer** read `path_deg` from the manifest as their inputs.
* **S5 Metrics** uses both `path_gt` and `path_deg` for PSNR, SSIM, LPIPS, and ArcFace.

S3 defines a controlled degradation space, ensuring both restoration models are evaluated on the exact same low-quality inputs.
